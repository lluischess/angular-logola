<!-- Layout reutilizable del backoffice -->
<app-backoffice-layout 
  pageTitle="Ficha de Presupuesto"
  [breadcrumbs]="[
    {label: 'Presupuestos', route: '/logoadmin/presupuestos'},
    {label: 'Ficha de Presupuesto'}
  ]">
  
  <!-- Contenido de la ficha -->
      <!-- Loading state -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Cargando ficha de presupuesto...</p>
      </div>

      <!-- Ficha de presupuesto -->
      <div *ngIf="!isLoading && presupuesto" class="presupuesto-detalle">
        <!-- Header de la ficha -->
        <div class="ficha-header">
          <div class="header-info">
            <h1>Presupuesto #{{ presupuesto.id }}</h1>
            <div class="estado-badge" [ngClass]="getEstadoClass(presupuesto.estado)">
              {{ getEstadoIcon(presupuesto.estado) }} {{ presupuesto.estado | titlecase }}
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" (click)="volverALista()">
              â† Volver a la lista
            </button>
            <button class="btn btn-primary" (click)="editarPresupuesto()">
              âœï¸ Editar
            </button>
            <button class="btn btn-outline" (click)="exportarPDF()">
              ğŸ“„ PDF
            </button>
          </div>
        </div>

        <!-- InformaciÃ³n de la empresa -->
        <div class="info-section">
          <h2>ğŸ“‹ InformaciÃ³n de la Empresa</h2>
          <div class="info-grid">
            <div class="info-card">
              <div class="info-row">
                <span class="info-label">Empresa:</span>
                <span class="info-value">{{ presupuesto.nombreEmpresa }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Contacto:</span>
                <span class="info-value">{{ presupuesto.nombreContacto }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">
                  <a href="mailto:{{ presupuesto.email }}">{{ presupuesto.email }}</a>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">TelÃ©fono:</span>
                <span class="info-value">
                  <a href="tel:{{ presupuesto.telefono }}">{{ presupuesto.telefono }}</a>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">DirecciÃ³n:</span>
                <span class="info-value">{{ presupuesto.direccion }}</span>
              </div>
            </div>

            <!-- Logo de la empresa -->
            <div class="logo-section">
              <h3>ğŸ¢ Logotipo de la Empresa</h3>
              <div class="logo-container">
                <img 
                  [src]="presupuesto.logoEmpresa" 
                  [alt]="'Logo de ' + presupuesto.nombreEmpresa"
                  class="empresa-logo"
                  (error)="onImageError($event, 'logo')">
              </div>
            </div>
          </div>
        </div>

        <!-- InformaciÃ³n del presupuesto -->
        <div class="info-section">
          <h2>ğŸ“… InformaciÃ³n del Presupuesto</h2>
          <div class="info-grid">
            <div class="info-card">
              <div class="info-row">
                <span class="info-label">Fecha de Presupuesto:</span>
                <span class="info-value">{{ formatDate(presupuesto.fecha) }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Estado:</span>
                <span class="info-value">
                  <span class="estado-badge" [ngClass]="getEstadoClass(presupuesto.estado)">
                    {{ getEstadoIcon(presupuesto.estado) }} {{ presupuesto.estado | titlecase }}
                  </span>
                </span>
              </div>

              <div class="info-row">
                <span class="info-label">Acepta Correos Publicitarios:</span>
                <span class="info-value">
                  <span class="marketing-badge" [class.accepted]="presupuesto.aceptaCorreosPublicitarios">
                    {{ presupuesto.aceptaCorreosPublicitarios ? 'âœ… SÃ­' : 'âŒ No' }}
                  </span>
                </span>
              </div>
            </div>

            <!-- Acciones de estado -->
            <div class="estado-actions">
              <h3>âš¡ Cambiar Estado</h3>
              <div class="estado-buttons">
                <button 
                  class="btn btn-warning" 
                  (click)="cambiarEstado('pendiente')"
                  [disabled]="presupuesto.estado === 'pendiente'">
                  â³ Pendiente
                </button>
                <button 
                  class="btn btn-success" 
                  (click)="cambiarEstado('aprobado')"
                  [disabled]="presupuesto.estado === 'aprobado'">
                  âœ… Aprobar
                </button>
                <button 
                  class="btn btn-info" 
                  (click)="cambiarEstado('enviado')"
                  [disabled]="presupuesto.estado === 'enviado'">
                  ğŸ“§ Enviado
                </button>
                <button 
                  class="btn btn-danger" 
                  (click)="cambiarEstado('rechazado')"
                  [disabled]="presupuesto.estado === 'rechazado'">
                  âŒ Rechazar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de productos -->
        <div class="info-section">
          <h2>ğŸ« Lista de Productos</h2>
          <div class="productos-table">
            <table class="table">
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto</th>
                  <th>CategorÃ­a</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of presupuesto.productos">
                  <td>
                    <img 
                      [src]="producto.imagen" 
                      [alt]="producto.nombre"
                      class="producto-imagen"
                      (error)="onImageError($event, 'product')">
                  </td>
                  <td class="producto-nombre">{{ producto.nombre }}</td>
                  <td class="producto-categoria">{{ producto.categoria }}</td>
                  <td class="producto-cantidad">{{ producto.cantidad }} uds.</td>
                </tr>
              </tbody>

            </table>
          </div>
        </div>



        <!-- Resumen de cantidades -->
        <div class="info-section">
          <h2>ğŸ“ Resumen de Cantidades</h2>
          <div class="resumen-cantidades">
            <div class="resumen-item">
              <span class="resumen-label">Cantidad Total</span>
              <span class="resumen-value">{{ presupuesto.cantidadTotal }}</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">Productos Diferentes</span>
              <span class="resumen-value">{{ presupuesto.productos.length }}</span>
            </div>
          </div>
        </div>

        <!-- SecciÃ³n de Apuntes -->
        <div class="info-section">
          <h2>ğŸ“ Apuntes y Notas</h2>
          <div class="apuntes-container">
            <!-- Modo visualizaciÃ³n -->
            <div *ngIf="!editingNotes" class="apuntes-display">
              <div class="apuntes-content">
                <p *ngIf="presupuesto.apuntes" class="apuntes-text">{{ presupuesto.apuntes }}</p>
                <p *ngIf="!presupuesto.apuntes" class="apuntes-empty">
                  <em>No hay apuntes aÃºn. Haz clic en "Editar" para aÃ±adir informaciÃ³n adicional.</em>
                </p>
              </div>
              <div class="apuntes-actions">
                <button class="btn btn-outline" (click)="editarApuntes()">
                  âœï¸ Editar Apuntes
                </button>
              </div>
            </div>

            <!-- Modo ediciÃ³n -->
            <div *ngIf="editingNotes" class="apuntes-edit">
              <div class="apuntes-form">
                <label for="apuntes-textarea" class="form-label">Apuntes y notas adicionales:</label>
                <textarea 
                  id="apuntes-textarea"
                  class="form-textarea" 
                  [(ngModel)]="tempNotes" 
                  placeholder="Escribe aquÃ­ cualquier informaciÃ³n adicional sobre este presupuesto..."
                  rows="5"
                  maxlength="1000">
                </textarea>
                <div class="character-count">
                  {{ tempNotes.length }}/1000 caracteres
                </div>
              </div>
              <div class="apuntes-actions">
                <button class="btn btn-success" (click)="guardarApuntes()">
                  âœ“ Guardar
                </button>
                <button class="btn btn-secondary" (click)="cancelarEdicionApuntes()">
                  âœ– Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error state -->
      <div *ngIf="!isLoading && !presupuesto" class="error-container">
        <div class="error-message">
          <h2>âŒ Presupuesto no encontrado</h2>
          <p>El presupuesto solicitado no existe o ha sido eliminado.</p>
          <button class="btn btn-primary" (click)="volverALista()">
            â† Volver a la lista de presupuestos
          </button>
        </div>
      </div>

</app-backoffice-layout>
