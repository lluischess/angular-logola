<!-- Layout reutilizable del backoffice -->
<app-backoffice-layout
  pageTitle="Ficha de Presupuesto"
  [breadcrumbs]="[
    {label: 'Presupuestos', route: '/logoadmin/presupuestos'},
    {label: 'Ficha de Presupuesto'}
  ]">

  <!-- Contenido de la ficha -->
      <!-- Loading state -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Cargando ficha de presupuesto...</p>
      </div>

      <!-- Ficha de presupuesto -->
      <div *ngIf="!isLoading && presupuesto" class="presupuesto-detalle">
        <!-- Header de la ficha -->
        <div class="ficha-header">
          <div class="header-info">
            <h1>Presupuesto #{{ presupuesto.numeroPresupuesto }}</h1>
            <div class="estado-badge" [ngClass]="getEstadoClass(presupuesto.estado)">
              {{ getEstadoIcon(presupuesto.estado) }} {{ presupuesto.estado | titlecase }}
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" (click)="volverALista()">
              ‚Üê Volver a la lista
            </button>

            <!-- Botones en modo normal -->
            <ng-container *ngIf="!isEditMode">
              <button class="btn btn-primary" (click)="editarPresupuesto()">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn btn-outline" (click)="descargarPDFNuevo()">
                üìÑ PDF
              </button>
            </ng-container>

            <!-- Botones en modo edici√≥n -->
            <ng-container *ngIf="isEditMode">
              <button class="btn btn-success" (click)="guardarPresupuesto()" [disabled]="isSaving">
                <span *ngIf="isSaving">üíæ Guardando...</span>
                <span *ngIf="!isSaving">üíæ Guardar</span>
              </button>
              <button class="btn btn-secondary" (click)="cancelarEdicion()" [disabled]="isSaving">
                üö´ Cancelar
              </button>
            </ng-container>
          </div>
        </div>

        <!-- Informaci√≥n de la empresa -->
        <div class="info-section">
          <h2>üìã Informaci√≥n de la Empresa</h2>
          <div class="info-grid">
            <div class="info-card">
              <!-- Modo de solo lectura -->
              <ng-container *ngIf="!isEditMode">
                <div class="info-row">
                  <span class="info-label">Empresa:</span>
                  <span class="info-value">{{ presupuesto.nombreEmpresa }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Contacto:</span>
                  <span class="info-value">{{ presupuesto.nombreContacto }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Email:</span>
                  <span class="info-value">
                    <a href="mailto:{{ presupuesto.email }}">{{ presupuesto.email }}</a>
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">Tel√©fono:</span>
                  <span class="info-value">
                    <a href="tel:{{ presupuesto.telefono }}">{{ presupuesto.telefono }}</a>
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">Direcci√≥n:</span>
                  <span class="info-value">{{ presupuesto.direccion }}</span>
                </div>
              </ng-container>

              <!-- Modo de edici√≥n -->
              <ng-container *ngIf="isEditMode">
                <div class="info-row">
                  <span class="info-label">Empresa:</span>
                  <div class="info-value">
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="presupuesto.nombreEmpresa"
                      placeholder="Nombre de la empresa">
                  </div>
                </div>
                <div class="info-row">
                  <span class="info-label">Contacto:</span>
                  <div class="info-value">
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="presupuesto.nombreContacto"
                      placeholder="Nombre del contacto">
                  </div>
                </div>
                <div class="info-row">
                  <span class="info-label">Email:</span>
                  <div class="info-value">
                    <input
                      type="email"
                      class="form-control"
                      [(ngModel)]="presupuesto.email"
                      placeholder="email@empresa.com">
                  </div>
                </div>
                <div class="info-row">
                  <span class="info-label">Tel√©fono:</span>
                  <div class="info-value">
                    <input
                      type="tel"
                      class="form-control"
                      [(ngModel)]="presupuesto.telefono"
                      placeholder="+34 600 000 000">
                  </div>
                </div>
                <div class="info-row">
                  <span class="info-label">Direcci√≥n:</span>
                  <div class="info-value">
                    <textarea
                      class="form-control"
                      [(ngModel)]="presupuesto.direccion"
                      placeholder="Direcci√≥n completa de la empresa"
                      rows="2"></textarea>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Logo de la empresa -->
            <div class="logo-section">
              <h3>üè¢ Logotipo de la Empresa</h3>
              <div class="logo-container">
                <img
                  [src]="presupuesto.logoEmpresa"
                  [alt]="'Logo de ' + presupuesto.nombreEmpresa"
                  class="empresa-logo"
                  (error)="onImageError($event, 'logo')">
              </div>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n del presupuesto -->
        <div class="info-section">
          <h2>üìÖ Informaci√≥n del Presupuesto</h2>
          <div class="info-grid">
            <div class="info-card">
              <div class="info-row">
                <span class="info-label">Fecha de Presupuesto:</span>
                <span class="info-value">{{ formatDate(presupuesto.fecha) }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Estado:</span>
                <span class="info-value">
                  <span class="estado-badge" [ngClass]="getEstadoClass(presupuesto.estado)">
                    {{ getEstadoIcon(presupuesto.estado) }} {{ presupuesto.estado | titlecase }}
                  </span>
                </span>
              </div>

              <div class="info-row">
                <span class="info-label">Acepta Correos Publicitarios:</span>
                <span class="info-value">
                  <span class="marketing-badge" [class.accepted]="presupuesto.aceptaCorreosPublicitarios">
                    {{ presupuesto.aceptaCorreosPublicitarios ? '‚úÖ S√≠' : '‚ùå No' }}
                  </span>
                </span>
              </div>

              <div class="info-row" *ngIf="presupuesto.observaciones">
                <span class="info-label">Observaciones del Cliente:</span>
                <span class="info-value">
                  <div class="observaciones-content">
                    {{ presupuesto.observaciones }}
                  </div>
                </span>
              </div>
            </div>

            <!-- Acciones de estado -->
            <div class="estado-actions">
              <h3>‚ö° Cambiar Estado</h3>
              <div class="estado-buttons">
                <button
                  class="btn btn-warning"
                  (click)="cambiarEstado('pendiente')"
                  [disabled]="presupuesto.estado === 'pendiente'">
                  ‚è≥ Pendiente
                </button>
                <button
                  class="btn btn-success"
                  (click)="cambiarEstado('aprobado')"
                  [disabled]="presupuesto.estado === 'aprobado'">
                  ‚úÖ Aprobar
                </button>
                <button
                  class="btn btn-info"
                  (click)="cambiarEstado('enviado')"
                  [disabled]="presupuesto.estado === 'enviado'">
                  üìß Enviado
                </button>
                <button
                  class="btn btn-danger"
                  (click)="cambiarEstado('rechazado')"
                  [disabled]="presupuesto.estado === 'rechazado'">
                  ‚ùå Rechazar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de productos -->
        <div class="info-section">
          <h2>üç´ Lista de Productos</h2>
          <div class="productos-table">
            <table class="table">
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto</th>
                  <th>Categor√≠a</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Total L√≠nea</th>
                  <th *ngIf="isEditMode">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of presupuesto.productos" [ngClass]="{'editing-row': isProductEditing(producto.id)}">
                  <td class="producto-imagen-cell">
                    <img
                      [src]="producto.imagen"
                      [alt]="producto.nombre"
                      class="producto-imagen"
                      (load)="onImageLoad($event, producto.nombre)"
                      (error)="onImageError($event, 'product')"
                      style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6;">
                  </td>
                  <td class="producto-nombre">{{ producto.nombre }}</td>
                  <td class="producto-categoria">{{ producto.categoria }}</td>

                  <!-- Cantidad - Editable en modo edici√≥n -->
                  <td class="producto-cantidad">
                    <span *ngIf="!isEditMode || !isProductEditing(producto.id)">{{ producto.cantidad }} uds.</span>
                    <input *ngIf="isEditMode && isProductEditing(producto.id)"
                           type="number"
                           [(ngModel)]="producto.cantidad"
                           min="1"
                           class="form-control form-control-sm"
                           style="width: 80px;">
                  </td>

                  <!-- Precio Unitario - Editable en modo edici√≥n -->
                  <td class="producto-precio-unitario">
                    <span *ngIf="!isEditMode || !isProductEditing(producto.id)">{{ formatCurrency(producto.precioUnitario) }}</span>
                    <input *ngIf="isEditMode && isProductEditing(producto.id)"
                           type="number"
                           [(ngModel)]="producto.precioUnitario"
                           min="0"
                           step="0.01"
                           class="form-control form-control-sm"
                           style="width: 100px;">
                  </td>

                  <td class="producto-precio-total"><strong>{{ formatCurrency(producto.precioTotal) }}</strong></td>

                  <!-- Acciones en modo edici√≥n -->
                  <td *ngIf="isEditMode" class="producto-acciones">
                    <!-- Botones cuando NO est√° editando este producto -->
                    <ng-container *ngIf="!isProductEditing(producto.id)">
                      <button class="btn btn-sm btn-outline-primary me-1" (click)="editarProducto(producto.id)" title="Editar producto">
                        ‚úèÔ∏è
                      </button>
                      <button class="btn btn-sm btn-outline-danger" (click)="eliminarProducto(producto.id)" title="Eliminar producto">
                        üóëÔ∏è
                      </button>
                    </ng-container>

                    <!-- Botones cuando S√ç est√° editando este producto -->
                    <ng-container *ngIf="isProductEditing(producto.id)">
                      <button class="btn btn-sm btn-success me-1" (click)="guardarProducto(producto.id)" title="Guardar cambios">
                        ‚úÖ
                      </button>
                      <button class="btn btn-sm btn-secondary" (click)="cancelarEdicionProducto(producto.id)" title="Cancelar edici√≥n">
                        ‚ùå
                      </button>
                    </ng-container>
                  </td>
                </tr>
              </tbody>

            </table>
          </div>
        </div>



        <!-- Resumen de cantidades y precios -->
        <div class="info-section">
          <h2>üìé Resumen del Presupuesto</h2>
          <div class="resumen-cantidades">
            <div class="resumen-item">
              <span class="resumen-label">Cantidad Total</span>
              <span class="resumen-value">{{ presupuesto.cantidadTotal }} uds.</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">Productos Diferentes</span>
              <span class="resumen-value">{{ presupuesto.productos.length }}</span>
            </div>
            <div class="resumen-item resumen-total">
              <span class="resumen-label">üí∞ <strong>TOTAL PRESUPUESTO</strong></span>
              <span class="resumen-value total-amount"><strong>{{ formatCurrency(presupuesto.precioTotal || 0) }}</strong></span>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de Apuntes -->
        <div class="info-section">
          <h2>üìù Apuntes y Notas</h2>
          <div class="apuntes-container">
            <!-- Modo visualizaci√≥n -->
            <div *ngIf="!editingNotes" class="apuntes-display">
              <div class="apuntes-content">
                <p *ngIf="presupuesto.apuntes" class="apuntes-text">{{ presupuesto.apuntes }}</p>
                <p *ngIf="!presupuesto.apuntes" class="apuntes-empty">
                  <em>No hay apuntes a√∫n. Haz clic en "Editar" para a√±adir informaci√≥n adicional.</em>
                </p>
              </div>
              <div class="apuntes-actions">
                <button class="btn btn-outline" (click)="editarApuntes()">
                  ‚úèÔ∏è Editar Apuntes
                </button>
              </div>
            </div>

            <!-- Modo edici√≥n -->
            <div *ngIf="editingNotes" class="apuntes-edit">
              <div class="apuntes-form">
                <label for="apuntes-textarea" class="form-label">Apuntes y notas adicionales:</label>
                <textarea
                  id="apuntes-textarea"
                  class="form-textarea"
                  [(ngModel)]="tempNotes"
                  placeholder="Escribe aqu√≠ cualquier informaci√≥n adicional sobre este presupuesto..."
                  rows="5"
                  maxlength="1000">
                </textarea>
                <div class="character-count">
                  {{ tempNotes.length }}/1000 caracteres
                </div>
              </div>
              <div class="apuntes-actions">
                <button class="btn btn-success" (click)="guardarApuntes()">
                  ‚úì Guardar
                </button>
                <button class="btn btn-secondary" (click)="cancelarEdicionApuntes()">
                  ‚úñ Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error state -->
      <div *ngIf="!isLoading && !presupuesto" class="error-container">
        <div class="error-message">
          <h2>‚ùå Presupuesto no encontrado</h2>
          <p>El presupuesto solicitado no existe o ha sido eliminado.</p>
          <button class="btn btn-primary" (click)="volverALista()">
            ‚Üê Volver a la lista de presupuestos
          </button>
        </div>
      </div>

</app-backoffice-layout>
