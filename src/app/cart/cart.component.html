<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasCart">
  <!-- Header con bot√≥n de cierre -->
  <div class="offcanvas-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <!-- Cuerpo del carrito -->
  <div class="offcanvas-body d-flex flex-column justify-content-between">

    <!-- Lista de productos en el carrito o mensaje de carrito vac√≠o -->
    <div *ngIf="cartItems.length > 0; else emptyCart">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span>Presupuesto</span>
        <span class="badge bg-primary rounded-pill">{{ cartItems.length }}</span>
      </h4>

      <ul class="list-group mb-3">
        <!-- Recorremos los productos con ngFor -->
        <ng-container *ngFor="let item of cartItems; let i = index">
          <!-- Producto -->
          <li class="list-group-item d-flex justify-content-between align-items-center lh-sm">
            <div class="d-flex gap-2">
              <!-- Imagen del producto -->
              <img [src]="getProductImage(item)" [alt]="getProductName(item)" width="60" height="40" class="rounded" (error)="onImageError($event)">
              <div>
                <h6 class="my-0" style="font-size: 0.92rem;">{{ getProductName(item) | titlecase }}</h6>
                <small class="text-body-secondary">{{ item.referencia }}</small>
              </div>
            </div>

            <!-- Cantidad -->
            <div class="quantity-selector d-flex align-items-center">
              <input id="quantity-input-{{i}}" type="number" [(ngModel)]="item.quantity"
                    class="form-control mx-1 text-center" (input)="updateQuantity(i)"
                    style="width: 100px;" [min]="getMinQuantity(item)" [placeholder]="'M√≠n: ' + getMinQuantity(item)" />
            </div>

            <!-- Bot√≥n de eliminar producto (peque√±a cruz) -->
            <button type="button" class="btn btn-close" aria-label="Remove" (click)="removeItem(item._id || item.id)"></button>
          </li>


        </ng-container>

        <!-- Total -->
        <li class="list-group-item d-flex justify-content-between">
          <strong>Total unidades: </strong>
          <strong>{{ totalUnits }}</strong>
        </li>
      </ul>
    </div>

    <!-- Plantilla para mostrar cuando el carrito est√° vac√≠o -->
    <ng-template #emptyCart>
      <div class="alert alert-warning" role="alert">
        <h5>Tu presupuesto est√° vac√≠o</h5>
        <p>No has a√±adido productos a tu presupuesto. Por favor, a√±ade productos para continuar.</p>
      </div>
    </ng-template>

    <!-- Checkbox para aceptar t√©rminos -->
    @if (cartItems.length > 0){
    <!-- Formulario de env√≠o de presupuesto -->
    <div class="form-container"> 
      <form [formGroup]="termsForm" (ngSubmit)="onSubmit()">
        <!-- Fila 1: Nombre y Email (escritorio) -->
        <div class="form-row-desktop d-none d-lg-flex">
          <div class="form-group">
            <label for="name" class="form-label">Nombre *</label>
            <input type="text" id="name" class="form-control" formControlName="name" required>
            <div *ngIf="termsForm.get('name')?.touched && termsForm.get('name')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('name')?.errors?.['required']">El nombre es requerido.</span>
            </div>
          </div>
          <div class="form-group">
            <label for="email" class="form-label">Email *</label>
            <input type="email" id="email" class="form-control" formControlName="email" required>
            <div *ngIf="termsForm.get('email')?.touched && termsForm.get('email')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('email')?.errors?.['required']">El email es requerido.</span>
              <span *ngIf="termsForm.get('email')?.errors?.['email']">El email no tiene un formato v√°lido.</span>
            </div>
          </div>
        </div>

        <!-- Fila 2: Tel√©fono y Empresa (escritorio) -->
        <div class="form-row-desktop d-none d-lg-flex">
          <div class="form-group">
            <label for="phone" class="form-label">Tel√©fono *</label>
            <input type="tel" id="phone" class="form-control" formControlName="phone" required>
            <div *ngIf="termsForm.get('phone')?.touched && termsForm.get('phone')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('phone')?.errors?.['required']">El tel√©fono es requerido.</span>
              <span *ngIf="termsForm.get('phone')?.errors?.['pattern']">El tel√©fono solo puede contener n√∫meros y espacios.</span>
            </div>
          </div>
          <div class="form-group">
            <label for="company" class="form-label">Empresa</label>
            <input type="text" id="company" class="form-control" formControlName="company">
          </div>
        </div>

        <!-- Direcci√≥n (escritorio) -->
        <div class="mb-3 d-none d-lg-block">
          <label for="address" class="form-label">Direcci√≥n</label>
          <input type="text" id="address" class="form-control" formControlName="address" placeholder="Calle, n√∫mero, ciudad, c√≥digo postal">
        </div>

        <!-- Versi√≥n m√≥vil - campos individuales -->
        <div class="d-lg-none">
          <!-- Nombre -->
          <div class="mb-3">
            <label for="name-mobile" class="form-label">Nombre *</label>
            <input type="text" id="name-mobile" class="form-control" formControlName="name" required>
            <div *ngIf="termsForm.get('name')?.touched && termsForm.get('name')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('name')?.errors?.['required']">El nombre es requerido.</span>
            </div>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email-mobile" class="form-label">Email *</label>
            <input type="email" id="email-mobile" class="form-control" formControlName="email" required>
            <div *ngIf="termsForm.get('email')?.touched && termsForm.get('email')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('email')?.errors?.['required']">El email es requerido.</span>
              <span *ngIf="termsForm.get('email')?.errors?.['email']">El email no tiene un formato v√°lido.</span>
            </div>
          </div>

          <!-- Tel√©fono -->
          <div class="mb-3">
            <label for="phone-mobile" class="form-label">Tel√©fono *</label>
            <input type="tel" id="phone-mobile" class="form-control" formControlName="phone" required>
            <div *ngIf="termsForm.get('phone')?.touched && termsForm.get('phone')?.invalid" class="text-danger">
              <span *ngIf="termsForm.get('phone')?.errors?.['required']">El tel√©fono es requerido.</span>
              <span *ngIf="termsForm.get('phone')?.errors?.['pattern']">El tel√©fono solo puede contener n√∫meros y espacios.</span>
            </div>
          </div>

          <!-- Empresa (opcional) -->
          <div class="mb-3">
            <label for="company-mobile" class="form-label">Empresa</label>
            <input type="text" id="company-mobile" class="form-control" formControlName="company">
          </div>

          <!-- Direcci√≥n (opcional) -->
          <div class="mb-3">
            <label for="address-mobile" class="form-label">Direcci√≥n</label>
            <input type="text" id="address-mobile" class="form-control" formControlName="address" placeholder="Calle, n√∫mero, ciudad, c√≥digo postal">
          </div>
        </div>

        <!-- Logotipo (opcional) -->
        <div class="mb-3">
          <label for="logo" class="form-label">Logotipo</label>
          <input type="file" id="logo" class="form-control" (change)="onFileSelected($event)">
        </div>

        <!-- Observaciones (opcional) -->
        <div class="mb-3">
          <label for="observaciones" class="form-label">Observaciones</label>
          <textarea 
            id="observaciones" 
            class="form-control" 
            formControlName="observaciones" 
            rows="4"
            maxlength="600"
            placeholder="A√±ade cualquier observaci√≥n o detalle adicional sobre tu presupuesto (m√°ximo 600 caracteres)">
          </textarea>
          <div class="form-text">
            <span [class.text-warning]="(termsForm.get('observaciones')?.value?.length || 0) > 500">
              {{ termsForm.get('observaciones')?.value?.length || 0 }}/600 caracteres
            </span>
          </div>
          <div *ngIf="termsForm.get('observaciones')?.touched && termsForm.get('observaciones')?.invalid" class="text-danger">
            <span *ngIf="termsForm.get('observaciones')?.errors?.['maxlength']">Las observaciones no pueden superar los 600 caracteres.</span>
          </div>
        </div>

        <!-- Checkbox para ofertas (opcional) -->
        <div class="form-check offers-checkbox mb-3">
          <input class="form-check-input" type="checkbox" id="receiveOffers" formControlName="receiveOffers">
          <label class="form-check-label" for="receiveOffers">
            üéÅ Deseo recibir ofertas y novedades en mi correo electr√≥nico
          </label>
        </div>

        <!-- Google reCAPTCHA v2 -->
        <div class="mb-3">
          <label class="form-label">Verificaci√≥n *</label>
          <div id="recaptcha-container"></div>
          <div *ngIf="!isRecaptchaValid && termsForm.touched" class="text-danger mt-2">
            Por favor, completa la verificaci√≥n reCAPTCHA.
          </div>
        </div>

        <!-- Aceptar t√©rminos -->
        <div class="form-check terms-checkbox required mb-3">
          <input class="form-check-input" type="checkbox" id="acceptTerms" formControlName="acceptTerms">
          <label class="form-check-label" for="acceptTerms">
            ‚úÖ Acepto que podemos enviarte correos electr√≥nicos. *
          </label>
          <div *ngIf="termsForm.get('acceptTerms')?.touched && termsForm.get('acceptTerms')?.invalid" class="text-danger">
            Debes aceptar los t√©rminos para continuar.
          </div>
        </div>

        <!-- Bot√≥n de enviar -->
        <button class="w-100 btn btn-primary btn-lg" type="submit" [disabled]="!termsForm.valid || isSubmitting">
          <span *ngIf="!isSubmitting">Enviar presupuesto</span>
          <span *ngIf="isSubmitting">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Enviando...
          </span>
        </button>
      </form>
    </div> <!-- Fin del form-container -->
  }
  </div>
</div>
